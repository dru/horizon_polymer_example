<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="horizon-collection">
  <script>

    var instances = [];
    
    Polymer({
      is: 'horizon-collection',
      
      properties: {
        name: {
          type: String
        },
        data: {
          type: Array,
          value: [],
          notify: true
        },
      },
      
      ready: function() {
        var that = this
        
        horizon(this.name).watch({rawChanges: true}).subscribe({
            next: function(change) { 
                switch(change.type) {
                case "initial":
                case "add":
                    that.push('data', change.new_val)
                    break;
                case "remove":
                    var index = that.data.findIndex(function(a){ return a.id == change.old_val.id});
                    if (index != -1) {
                        that.splice('data', index, 1);
                    }
                    break;
                case "change":
                    var index = that.data.findIndex(function(a){ return a.id == change.old_val.id});
                    if (index != -1) {
                        that.set(`data.${index}`, change.new_val)
                    }
                }
            },
            error: function(err) { console.error(`Error: ${err}`) }
        });

      },
      
      insert: function(data) {
        horizon(this.name).store(data).subscribe();
      },
      
      remove: function(id) {
        horizon(this.name).remove(id);
      },
      
      update: function(data) {
        horizon(this.name).update(data);
      },
      
      removeAll: function() {
        var that = this
        horizon(this.name).fetch()
        .mergeMap(function(messageList){ horizon(that.name).removeAll(messageList)})
        .subscribe({
            next: function(id)   { console.log(`id ${id} was removed`) },
            error: function(err) { console.error(`Error: ${err}`) },
            complete: function() { console.log('All items removed successfully') }
        });
      }
      

    });
  </script>
</dom-module>
